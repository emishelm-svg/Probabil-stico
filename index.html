<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Titanic Decision Tree - Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root { --bg: #0f172a; --accent: #38bdf8; }
        body { font-family: sans-serif; display: flex; height: 100vh; margin: 0; background: #f1f5f9; }
        #sidebar { width: 300px; background: var(--bg); color: white; padding: 20px; }
        #canvas { flex-grow: 1; position: relative; }
        .btn { background: var(--accent); color: #000; border: none; padding: 10px; cursor: pointer; width: 100%; border-radius: 5px; font-weight: bold; }
        .error-msg { color: #f87171; font-size: 12px; margin-top: 10px; display: none; }
        input[type="file"] { margin: 10px 0; color: white; font-size: 12px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>Titanic Lab</h2>
    <p>Si el archivo automático falla, selecciona el CSV manualmente:</p>
    <input type="file" id="csvInput" accept=".csv">
    <hr>
    <button class="btn" onclick="tryLoadAuto()">Reintentar Carga Auto</button>
    <div id="errorLog" class="error-msg">Error: No se encontró el archivo en el repo.</div>
</div>

<div id="canvas">
    <h3 style="padding-left: 20px;">Árbol de Decisión Generado</h3>
    <div id="tree"></div>
</div>

<script>
    // 1. Carga automática al iniciar
    window.onload = () => tryLoadAuto();

    // 2. Carga desde el input manual (por si falla el repo)
    document.getElementById('csvInput').onchange = function(e) {
        const file = e.target.files[0];
        Papa.parse(file, {
            header: true,
            dynamicTyping: true,
            complete: (results) => processAndRender(results.data)
        });
    };

    function tryLoadAuto() {
        document.getElementById('errorLog').style.display = 'none';
        Papa.parse("Titanic-Dataset.csv", {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                processAndRender(results.data);
            },
            error: function() {
                document.getElementById('errorLog').style.display = 'block';
                console.error("No se pudo cargar automáticamente.");
            }
        });
    }

    function processAndRender(data) {
        console.log("Datos cargados:", data.length);
        // Aquí va la lógica de dibujo D3 que enviamos antes
        const sampleTree = {
            name: "Total: " + data.length,
            children: [
                { name: "Mujeres: Sobreviven", children: [{name: "80%"}] },
                { name: "Hombres: Fallecen", children: [{name: "20%"}] }
            ]
        };
        renderD3(sampleTree);
    }

    function renderD3(treeData) {
        d3.select("#tree").selectAll("*").remove();
        const width = 600, height = 400;
        const svg = d3.select("#tree").append("svg").attr("width", width).attr("height", height)
                      .append("g").attr("transform", "translate(50,50)");
        
        const treeLayout = d3.tree().size([height-100, width-200]);
        const root = d3.hierarchy(treeData);
        treeLayout(root);

        svg.selectAll(".link").data(root.links()).enter().append("path").attr("fill", "none").attr("stroke", "#ccc")
           .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        const node = svg.selectAll(".node").data(root.descendants()).enter().append("g")
                        .attr("transform", d => `translate(${d.y},${d.x})`);
        node.append("circle").attr("r", 5).attr("fill", "#38bdf8");
        node.append("text").attr("dy", 15).text(d => d.data.name).style("font-size", "10px");
    }
</script>
</body>
</html>
